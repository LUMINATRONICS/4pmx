# 4PMx-Device: 통증 다원 분석 및 보안 SW

## 1. 프로젝트 개요
4PMx-Device는 정량감각검사(QST), 시각통증지각검사(VPT), 언어적통증지각검사(LPT) 등 다각적인 통증 측정을 수행하고,<br/> 그 결과를 안전하게 관리 및 분석하는 로컬 서버(폐쇄망) 애플리케이션입니다.<br/>
본 시스템은 환자 데이터의 무결성과 기밀성을 보장하기 위해 보안 기능을 내장하고 있으며,<br/> 특히 라즈베리파이와 같은 임베디드 장치에서의 안정적인 운영을 목표로 설계되었습니다.
<br/>모든 데이터는 AES-256으로 암호화되어 저장되며, 서버 실행 전 소스 코드의 무결성 및 바이러스 검사를 통해 잠재적인 위협을 사전에 차단합니다.<br/>

## 2. 주요 기능
### 2.1. 통증 측정 및 관리
다중 검사 프로토콜: QST, VPT(VAS), LPT(PDS) 및 설문(NPQ, PDQ, MPQ) 검사 수행.<br/>
원격 제어 및 환자 모니터링: 의사용 제어 페이지(control.html)와 환자용 검사 페이지(index.html) 분리 운영.<br/>
실시간 데이터 시각화: WebSocket을 통해 검사 중인 온도 데이터를 실시간 차트로 표시.<br/>
환자 및 의사 관리: 관리자 계정을 통한 의사 계정 생성/관리 및 환자 정보 등록/관리 기능.<br/>
### 2.2. 데이터 처리 및 분석
자동 데이터 처리: 측정된 데이터를 DataFrame으로 변환 후 CSV 파일로 저장.<br/>
결과 분석 및 시각화: 저장된 검사 데이터를 기반으로 종합 결과 페이지(result.html)에서 차트와 요약 테이블 제공.<br/>
AI 기반 종합 소견: 측정 결과를 바탕으로 AI가 생성한 종합 소견 제공.<br/>
### 2.3. 보안 강화 기능
데이터 암호화: 모든 환자 정보(.json) 및 검사 결과(.csv)를 AES-256으로 암호화하여 저장.<br/>
소스 코드 무결성 검증: 서버 시작 시, checksums.json을 기준으로 모든 소스 코드 파일의 변경 여부를 SHA-256 해시로 검증. 변경 시 서버 실행 차단.<br/>
자동 바이러스 검사: 서버 시작 전, ClamAV를 이용해 프로젝트 폴더 전체의 바이러스 검사를 수행. 바이러스 탐지 시 감염 파일을 자동으로 격리하고 서버 실행을 차단.<br/>
USB 통제 및 무결성 검사:<br/>
-USB를 통해 PC로 파일을 복사할 때 .csv 확장자만 허용하고, 다른 형식의 파일 및 폴더는 자동으로 삭제.<br/>
-복사된 .csv 파일은 원본과 해시값을 비교하여 데이터 무결성 검증.<br/>
네트워크 포트 통제: 부팅 시 자동으로 이더넷 포트(eth0)를 비활성화하여 인가되지 않은 유선 네트워크 접근을 차단.<br/>
주기적 시스템 감시:<br/>
-저장 공간 모니터링: 5분마다 디스크 사용량을 체크하여 임계치(90%) 초과 시 경고, 위험 수위(95%) 도달 시 서버를 안전하게 종료.<br/>
-주기적 바이러스 검사: 매일 새벽, .../Documents 폴더 전체를 대상으로 바이러스 검사를 수행하고 로그를 기록.<br/>
### 2.4. 시스템 관리 및 운영
서비스 자동 실행: systemd 서비스를 통해 시스템 부팅 시 모든 서버 및 모니터링 스크립트가 자동으로 실행.<br/>
세션 관리 및 잠금: 사용자 비활성 시간이 6시간을 초과하면 자동으로 세션을 잠금 처리하여 재인증 요구.<br/>
데이터 백업 및 복원: 관리자 페이지에서 시스템의 현재 상태를 압축 파일로 백업하고, 이전 상태로 복원하는 기능 제공.<br/>

## 3. 시스템 아키텍처 및 구성 요소
웹 프레임워크: Flask (Python)<br/>
실시간 통신: Flask-SocketIO, Eventlet<br/>
데이터 처리: Pandas<br/>
암호화: PyCryptodome (AES), Passlib (bcrypt)<br/>
보안 검사: ClamAV (바이러스), hashlib (무결성)<br/>
자동화 및 서비스: systemd, cron<br/>
하드웨어 제어: Web Serial API (웹 브라우저)<br/>
파일 시스템 모니터링: Watchdog (Python)<br/>
프론트엔드: HTML, CSS, JavaScript (Vanilla JS)<br/>
### 주요 스크립트 및 파일<br/>
| 파일/스크립트 | 역할 |
| :-: | -- |
| server.py |	메인 Flask 웹 서버. API 엔드포인트, 페이지 렌더링, 데이터 암복호화 및 무결성 검사 로직 포함|
| web_socket.py | 실시간 통신을 위한 Socket.IO 서버|
| usb_integrity_check.py | USB 연결을 감지하고, PC로 복사되는 파일의 확장자 및 무결성을 검사하는 백그라운드 스크립트|
| bootsetup.sh | 최초 1회 실행. 시스템 서비스, 자동 실행, SSL 인증서 등 서버 운영에 필요한 모든 환경을 설정|
| bootsetup_init.sh | 최초 1회 실행. 보안 기능(저장공간, ClamAV, USB 감시, 이더넷 차단)을 설정하고 서비스로 등록|
| run.sh | systemd 서비스에 의해 호출되는 실행 스크립트. 바이러스 검사 후 server.py와 web_socket.py 실행|
| generate_checksums.py | 소스 코드 무결성 검사를 위한 checksums.json 파일을 생성. (코드 배포/수정 시 실행 필요)|
| json/config.json | 서버 포트, SSL 인증서 경로 등 주요 설정값 저장|

## 4. 설치 및 설정 가이드
### 4.1. 사전 준비
운영체제: Debian 기반 리눅스(라즈비안) <br/>
사용자 계정: (예시)raspberry <br/>
프로젝트 위치: .../4pmx/ver2 <br/>
### 4.2. 설치 절차
프로젝트 클론 또는 복사:
프로젝트 파일 전체를 권장 위치로 복사합니다.<br/>
소스 코드 체크섬 생성:
배포된 소스 코드의 무결성 기준을 설정하기 위해 아래 명령어를 실행합니다.
```c
cd .../4pmx/ver2
python3 generate_checksums.py
```
메인 설정 스크립트 실행:
bootsetup.sh는 서버 운영에 필요한 모든 환경(시스템 패키지, Python 가상환경, SSL 인증서, 자동 실행 서비스 등)을 설정합니다.<br/>
스크립트에 실행 권한을 부여하고 실행합니다. sudo 없이 실행해야 합니다.<br/>
```c
chmod +x bootsetup.sh
./bootsetup.sh
```
초기 보안 설정 스크립트 실행:
bootsetup_init.sh는 저장 공간 모니터링, USB 감시, ClamAV, 이더넷 차단 등 추가적인 보안 및 운영 기능을 시스템에 등록합니다.
스크립트에 실행 권한을 부여하고 sudo로 실행해야 합니다.
```c
chmod +x bootsetup_init.sh
sudo ./bootsetup_init.sh
```
시스템 재부팅:
모든 설정과 서비스가 시스템에 완전히 적용되도록 재부팅을 권장합니다.
```c
sudo reboot
```
## 5. 사용 방법
접속: 웹 브라우저를 열고 https://localhost 또는 https://<라즈베리파이_IP> 주소로 접속합니다.<br/>
로그인: 초기 관리자 계정은 admin 입니다. 로그인 후 관리자 아이디 생성을 권장합니다.<br/>
의사 관리: 관리자 계정으로 로그인 후, 환자 목록 페이지의 사용자 관리 버튼을 통해 의사 계정을 추가/삭제/비밀번호 변경할 수 있습니다.<br/>
환자 등록 및 검사 시작:<br/>
-초기 실행 시) 환자 목록 페이지에서 환자 등록 버튼을 클릭하여 환자 정보를 입력합니다.<br/>
-등록된 환자 목록에서 검사를 진행할 환자의 선택 버튼을 클릭합니다.<br/>
-팝업으로 열리는 제어 창(control.html)에서 검사 설정을 조정한 후 검사 시작을 누릅니다. 환자용 화면(index.html)에서 검사가 진행됩니다.<br/>

## 6. 로그 및 데이터 위치
#### 메인 로그: .../logs/<날짜시간>/
USB 감시 로그: .../logs/usb_integrity.log<br/>
저장 공간 경고 로그: .../storage_alert.log<br/>
#### 바이러스 검사 로그:
서버 시작 시: .../logs/clamav_startup_scan.log<br/>
주기적 검사: .../logs/clamav_daily_scan.log<br/>
바이러스 격리 폴더: .../logs/quarantine/<br/>
#### 암호화된 데이터:
검사 결과: .../csv/<br/>
환자/의사 정보: .../json/<br/>
백업 파일: .../backup/ 

# 4PMx-Device HW
통증 진단기기는 주문제작한 팰티어와 PID제어를 사용하여 원하는 온도 도달<br/>
동작 온도 : -5°C ~ 50°C <br/>
<img width="659" height="797" alt="Image" src="https://github.com/user-attachments/assets/95aa91cf-6568-4305-b111-704b65a1dcb9" />
